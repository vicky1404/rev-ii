begin
for CUR_BORRAR
in(SELECT 
ES.ID_ESTRUCTURA,
VE.ID_VERSION,
PE.PERIODO
FROM 
REV_ESTRUCTURA ES,
REV_VERSION VE,
REV_VERSION_PERIODO VP,
REV_PERIODO PE
WHERE
es.id_version =  ve.id_version AND
VE.ID_VERSION = VP.ID_VERSION AND
VP.ID_PERIODO = PE.ID_PERIODO AND
PE.PERIODO = 201109) loop

DELETE FROM REV_FORMULA_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CAMPO_FORMULA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CELDA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_AGRUPACION_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_TEXTO WHERE ID_TEXTO = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HTML WHERE ID_HTML = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HISTORIAL_VERSION WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;
DELETE FROM REV_ESTRUCTURA WHERE ID_ESTRUCTURA = CUR_BORRAR.ID_ESTRUCTURA;
end loop;
end;


begin
for CUR_BORRAR
in(SELECT 
VP.ID_VERSION
FROM 
REV_VERSION_PERIODO VP,
REV_PERIODO PE
WHERE
VP.ID_PERIODO = PE.ID_PERIODO AND
PE.PERIODO = 201109) loop

DELETE FROM REV_VERSION_PERIODO WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;
DELETE FROM REV_VERSION WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;

end loop;
end;

update rev_periodo 
set id_estado_periodo = 0 where periodo = 201112

begin
for CUR_UPDATE
in(SELECT MAX(ID_VERSION) ID_VERSION FROM REV_VERSION GROUP BY ID_CATALOGO) loop
	update REV_VERSION set vigencia = 1 WHERE ID_VERSION = CUR_UPDATE.ID_VERSION;
end loop;
end;




begin
for CUR_BORRAR
in(SELECT 
*
FROM 
REV_ESTRUCTURA ES
WHERE
ES.ID_VERSION IN(
137,
138,
139,
140, 
26,
27,
80)) loop

DELETE FROM REV_FORMULA_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CAMPO_FORMULA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CELDA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_AGRUPACION_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_TEXTO WHERE ID_TEXTO = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HTML WHERE ID_HTML = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HISTORIAL_VERSION WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;
DELETE FROM REV_ESTRUCTURA WHERE ID_ESTRUCTURA = CUR_BORRAR.ID_ESTRUCTURA;

end loop;
end;





begin
for CUR_BORRAR
in(SELECT * FROM 
REV_ESTRUCTURA ES
WHERE 
ES.ID_VERSION NOT IN(SELECT MAX(ID_VERSION) ID_VERSION FROM REV_VERSION GROUP BY ID_CATALOGO)) loop

DELETE FROM REV_FORMULA_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CAMPO_FORMULA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_CELDA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_AGRUPACION_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_COLUMNA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_GRILLA WHERE ID_GRILLA = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_TEXTO WHERE ID_TEXTO = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HTML WHERE ID_HTML = CUR_BORRAR.ID_ESTRUCTURA;
DELETE FROM REV_HISTORIAL_VERSION WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;
DELETE FROM REV_ESTRUCTURA WHERE ID_ESTRUCTURA = CUR_BORRAR.ID_ESTRUCTURA;
end loop;
end;

COMMIT;



begin
for CUR_BORRAR
in(SELECT * FROM 
REV_VERSION VER
WHERE 
VER.ID_VERSION NOT IN(SELECT MAX(ID_VERSION) ID_VERSION FROM REV_VERSION GROUP BY ID_CATALOGO)) loop

DELETE FROM REV_VERSION_PERIODO WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;
DELETE FROM REV_VERSION WHERE ID_VERSION = CUR_BORRAR.ID_VERSION;

end loop;
end;


COMMIT;